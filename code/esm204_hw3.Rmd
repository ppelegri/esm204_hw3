---
title: "ESM 204 HW 3"
author: "Patrick Pelegri-O'Day"
date: "5/2/2022"
output: html_document
---

```{r setup, include=FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

library(here)
library(tidyverse)
library(janitor)
```

**TO-DOS**

 - GRAPH SUPPLY AND DEMAND CURVES
 - HOW TO SET D_AGG CURVE = TO SUPPLY CURVE W/ TAX? (Where is the equation that describes the aggregate demand curve?)

**Starting facts**

 - Consumers can be separated into two income groups: “high” and “low.” The data set provides price (in $) and quantity (in kWh) estimates of demand per month for the two groups. Run linear regressions (with an intercept) to estimate the demand curves for “high” and “low” income consumers.
 - Initially, there is no tax on electricity consumption.
 - The current electricity price (without any taxes) is $.10 per kWh.
 - The marginal cost of producing a kWh of electricity is linear and has a price-intercept of 0.

### Step 0

```{r}
# Read in energy data
energy_raw <- read_csv(here('data', 'HW3_data.csv'))

energy <- clean_names(energy_raw) %>% 
  select(-1) %>% 
  mutate(q_agg_kwh = q_high_kwh + q_low_kwh)
```


```{r}
# Run linear regression to estimate demand curves for high- and low-income consumers
low_lm <- lm(price_cents ~ q_low_kwh, data = energy)
high_lm <- lm(price_cents ~ q_high_kwh, data = energy)
```

### Question 1

One kWh of electricity emits 0.85 pounds of CO2. Assuming that the interim SCC correctly reflects the total social cost of one metric ton of CO2, what is the marginal externality cost per kwH of electricity?

- 1 kWh of electricity = 0.85 lb CO2
- 1 metric ton = 2204.6 lbs. Thus 1 metric ton of CO2 is emitted from 2204.6/0.85 = 2594 kWh of electricity
- SCC is $51/MT CO2. Thus, the SCC is set to 51 USD per 2594 kWh, or 1.97 cents per kWh.
- The marginal external cost of 1 kWh of electricity production considering the impacts of carbon emissions associated with that electricity production is **1.97 cents per kWh.** Note: there may be other negative external costs associated with non-carbon characteristics of electricity production such as land use. Those are not included in this external cost.

### Question 2

```{r}
# need to rearrange the parameter to get Q(P)! 
# Qagg = Qlow(P) + Qlow(h) 
# Importantly, since the y-intercepts are different, we know that Qagg(P) will have a kink. I include an ifelse() statement to take care of the kink.

# Define demand function
demand <- function(p, model){
  q <- (p - model$coefficients[[1]]/model$coefficients[[2]]) # numerator = m, denominator = b
  q <- ifelse(q<0, 0, q)
  return(q)
}
```

```{r}
# for each p level, return estimated aggregate demand
demand_agg <- function(p){
  q <- demand(p, low_lm) + demand(p, high_lm)
  return(q)
}
```

The aggregate monthly demand curve for electricity is found by horizontally stacking the demand curves for high income and low income consumers.

To find the supply curve, we want to know the quantity of kWh where aggregate demand equals 10 cents. This is 819,733.7 kWh. Since we know the origin of the supply curve is at y = 0 and the curve is linear, we can simply find the slope coefficient that connects the points (0 kWh, 0 cents/kWh) and (819,733.7 kWh, 10 cents/kWh).

**The supply and demand curves are graphed below.**

```{r}
# Storing intercepts and slopes as objects
low_int <- low_lm$coefficients[1]
low_slp <- low_lm$coefficients[2]
high_int <- high_lm$coefficients[1]
high_slp <- high_lm$coefficients[2]

# Creating functions for both demand groups for graphing
d_low <- function(q) {low_slp*q + low_int}
d_high <- function(q) {high_slp*q + high_int}

# Creating an overall demand function for calculations
dem <- function(p, model){
  q <- (p - model$coefficients[[1]])/model$coefficients[[2]]
  q <- ifelse(q<0,0,q)
  return(q)
}

# Creating an aggregate demand function
dem_agg <- function(p){
  q <- dem(p, low_lm) + dem(p, high_lm)
  return(q)
}

# Creating a sequence to map the aggregate demand function for plotting
price = seq(0, 32, length.out = 100)
qagg <- map(price, dem_agg) %>% 
  unlist()

# Putting the sequence into a dataframe
df <- tibble(qagg = qagg, price = price)

# Storing the intercept and slope of the aggregate
d_agg_slp <- (0-low_int)/(dem_agg(0)-dem_agg(low_int))
d_agg_int <- 0 - d_agg_slp*dem_agg(0)
d_agg_plot <- function(q) {d_agg_slp*q + d_agg_int}

# Creating the MPC, MSC, MEC functions
mpc_slp <- (10/dem_agg(10)) # MPC slope
mpc <- function(q) {mpc_slp*q + 0} # MPC function
mpc_q <- function(p) {p/mpc_slp} # MPC in terms of Q
mec <- function(q) {1.97} # MEC function
msc <- function(q) {mpc(q) + mec(q)} # MSC function
msc_q <- function(p) {(p-1.97)/mpc_slp}

# Consumer surplus function
cs <- function(p, model){
  q <- dem(p, model)
  con_sur <- 0.5*(model$coefficients[[1]] - p)*q
  return(con_sur)
}

# Aggregate consumer surplus function
cs_agg <- function(p){
  cs <- cs(p,low_lm) + cs(p,high_lm)
  return(cs)
}

# Producer surplus function
ps <- function(p){
  q <- mpc_q(p)
  prod_sur <- 0.5*q*p
  return(prod_sur)
}
```

```{r}
ggplot() +
  stat_function(color = "royalblue2", fun = d_low, size = 1, linetype = "twodash") +
  stat_function(color = "royalblue4", fun = d_high, size = 1, linetype = "twodash") +
  stat_function(color = "red3", fun = mpc, size = 0.75) +
  stat_function(color = "orange3", fun = msc, size = 0.75) +
  stat_function(color = "green4", fun = mec, size = 0.75) +
  geom_point(aes(mpc_q(10),10), size = 0.75, color = "blue") +
  geom_line(data = df, aes(x = qagg, y = price), color = "purple4", size = 1) +
  scale_x_continuous(name="Electricity (kWh)", limits=c(0,900000),expand = c(0, 0)) +
  scale_y_continuous(name="Price (cents)\n", limits=c(0,40),expand = c(0, 0)) +
  geom_text(aes(label = "Low Demand", x = 140000, y = 10), angle = -54, size = 3) +
  geom_text(aes(label = "High Demand", x = 370000, y = 14), angle = -33, size = 3) +
  geom_text(aes(label = "Aggregate Demand", x = 450000, y = 14.5), angle = -24, size = 3) +
  geom_text(aes(label = "MPC", x = 750000, y = 14.75), angle =11, size = 3) +
  geom_text(aes(label = "MSC", x = 800000, y = 18), angle = 11, size = 3) +
  geom_text(aes(label = "MEC", x = 850000, y = 3), size = 3) +
  theme_classic() +
  theme(legend.title = element_blank(),
        legend.position = c(0.95, 0.95), 
        legend.justification = c(1, 1),
        legend.spacing = unit(0, "cm"), 
        legend.margin = margin(0, 0, 0, 0, "cm"))
```


**Consumer surplus under status quo:** Total consumer surplus at a price of 10 cents is **52,987.22 USD.** 

**Producer surplus under status quo:** Producer surplus at a price of 10 cents is **26,835.97 USD**

**Environmental cost under status quo:** 1.97 cents/kWh * 819,733.7 kWh = **16,148.75 USD**

### Question 3

Under the status quo, the **consumer surplus for low-income consumers is 8,112.43 USD** and the **surplus for high-income consumers is 44,874.79 USD.** That is, the surplus for high-income consumers is over five times larger than the surplus for low-income consumers.

### Question 4

```{r}
# Find the new equilibrium price at the intersection of dem_agg and msc
uniroot(function(p)
  dem_agg(p) - msc_q(p),
        interval = c(0,20))
```

Applying a tax on producers to address the interim SCC will shift the producer supply curve up by 1.97 cents/kWh. Setting MSC equal to the aggregate demand curve, we find that the **new equilibrium price of electricity will be 11.29 cents/kWh.**

 - Quantity of electricity: **500,213.2 kWh**
 - Welfare of high income consumers: **39,676.40 USD**
 - Welfare of low income consumers: 6,622.60 USD surplus minus a cumulative external cost of 9,854.20 USD borne entirely by low-income consumers results in a **net loss of 3,231.60 USD**
 - Welfare of power suppliers (i.e. producers): **34,206.23 USD**
 - Total environmental damage: MEC times quantity produced = **9,854.20 USD**
 - Total tax revenue generated: size of the tax = MEC. So the total tax revenue generated will also be **9,854.20 USD**
 
 ### Question 5
 
 Assume that tax revenue is returned to consumers in the proportion that they consumed the electricity.
 
 Calculate the following at a range of SCC values: 51, 75, 100, 125, 150




############ OLD #############

# ```{r}
# CS <- function(p, model){
#   q <- demand(p, model)
#   cs <- 0.5*(model$coefficients[[1]] - p)*q
#   return(cs)
# }
# ```
# 
# ```{r}
# CS_agg <- function(p){
#   cs <- CS(p,model_demand_l) + CS(p,model_demand_h)
#   return(cs)
# }
# ```
# 
# ```{r}
# PS <- function(p){
#   ps <- 0.5*(p/0.0000121991)
#   return(ps)
# }
# ```
# 
# 10 = 819733.7x
# x = 0.0000121991
# supply curve: y = 0.0000121991x
# 

# ```{r}
# price = seq(0, 30, length.out = 100)
# Qagg <- map(price, demand_agg) %>% unlist()
# 
# df<- tibble(Qagg = Qagg, price = price)
# 
# ggplot(df, aes(Qagg, price)) +
#   geom_line()
# ```
